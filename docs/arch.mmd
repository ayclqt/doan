flowchart TD
    subgraph "Người dùng"
        USER[Người dùng] <-->|Tương tác| FE
    end

    subgraph "Frontend"
        FE[Streamlit UI] <-->|API Calls| BE
    end

    subgraph "Backend"
        BE[Backend Service] <-->|gRPC| CORE
        BE <-->|Quản lý hàng đợi| QUEUE[RabbitMQ]
        QUEUE <-->|Xử lý tác vụ| WORKER[Dramatiq Workers]

        subgraph "Core Chatbot"
            CORE[Core Service] --> LC[LangChain Pipeline]

            LC -->|Quản lý hội thoại| MEMORY[Conversation Memory]
            LC -->|Vector Search| VDB[Qdrant]
            LC -->|Prompt Engineering| PROMPT[Prompt Templates]
            LC -->|Gọi LLM API| LITELLM[LiteLLM]

            LITELLM -->|API Calls| LLM[Large Language Models]
        end

        WORKER -->|Truy xuất dữ liệu| DB[(Database)]
        WORKER -->|Xử lý tác vụ nặng| CORE
    end

    subgraph "Dữ liệu & Tích hợp"
        DB -->|Dữ liệu sản phẩm| PROCESS[Data Processor]
        PROCESS -->|Text Chunking| CHUNKS[Text Chunks]
        CHUNKS -->|Embedding| VECTORS[Vector Embeddings]
        VECTORS --> VDB

        INTEGRATION[External APIs] <--> BE
    end

    subgraph "Bảo mật"
        SEC_LAYER[Security Layer] -.-> FE
        SEC_LAYER -.-> BE
        SEC_LAYER -.-> CORE

        SEC_COMP[Security Components]
        SEC_COMP -->|Mã hóa| ENC[AES-256 & RSA]
        SEC_COMP -->|Xác thực| AUTH[Authentication]
        SEC_COMP -->|Phòng chống tấn công| PROTECT[Injection & Prompt Protection]
    end

    subgraph "Deployment & Monitoring"
        DEPLOY[Deployment Service] -.-> FE
        DEPLOY -.-> BE
        DEPLOY -.-> CORE

        MONITOR[Monitoring System] -.-> FE
        MONITOR -.-> BE
        MONITOR -.-> CORE
        MONITOR -.-> QUEUE
    end

    classDef user fill:#f9f9f9,stroke:#333,stroke-width:1px
    classDef frontend fill:#d5e8d4,stroke:#82b366,stroke-width:2px
    classDef backend fill:#dae8fc,stroke:#6c8ebf,stroke-width:2px
    classDef core fill:#ffe6cc,stroke:#d79b00,stroke-width:2px
    classDef data fill:#fff2cc,stroke:#d6b656,stroke-width:2px
    classDef security fill:#f8cecc,stroke:#b85450,stroke-width:2px
    classDef deployment fill:#e1d5e7,stroke:#9673a6,stroke-width:2px

    class USER user
    class FE frontend
    class BE,QUEUE,WORKER backend
    class CORE,LC,MEMORY,VDB,PROMPT,LITELLM,LLM core
    class DB,PROCESS,CHUNKS,VECTORS,INTEGRATION data
    class SEC_LAYER,SEC_COMP,ENC,AUTH,PROTECT security
    class DEPLOY,MONITOR deployment
